# Real-Time –°–æ–æ–±—â–µ–Ω–∏—è: –ü–æ–ª–Ω–æ–µ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è Frontend

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ß—Ç–æ —Ç–∞–∫–æ–µ Real-Time –∏ –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?](#—á—Ç–æ-—Ç–∞–∫–æ–µ-real-time)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ](#–±—ç–∫–µ–Ω–¥)
4. [–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ](#—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)
5. [–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä)
6. [–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã](#faq)

---

## üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ Real-Time –∏ –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç? {#—á—Ç–æ-—Ç–∞–∫–æ–µ-real-time}

**Real-Time** –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –¥–µ–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

### –û–±—ã—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–±–µ–∑ Real-Time):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚Üì
–°–µ—Ä–≤–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å
    ‚Üì
–¢–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ –æ–Ω —É–≤–∏–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

### Real-Time –ø–æ–¥—Ö–æ–¥:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚Üì
–°–µ—Ä–≤–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
    ‚Üì
–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ú–ì–ù–û–í–ï–ù–ù–û
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è {#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞}

–ù–∞—à Real-Time —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ **GraphQL Subscriptions** + **WebSocket**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend   ‚îÇ
‚îÇ  (React/Vue) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ WebSocket Connection
       ‚îÇ (ws://localhost:4000/graphql)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      SubscriptionServer              ‚îÇ
‚îÇ  (subscriptions-transport-ws)       ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è   ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é         ‚îÇ
‚îÇ  ‚Ä¢ –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∞–º–∏              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      GraphQL Resolvers              ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ  ‚Ä¢ sendMessage: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚îÇ
‚îÇ  ‚Ä¢ messageAdded: –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         PubSub                      ‚îÇ
‚îÇ  (Event Publisher/Subscriber)        ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ  ‚Ä¢ –ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è                ‚îÇ
‚îÇ  ‚Ä¢ –£–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      MongoDB                        ‚îÇ
‚îÇ  (–•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ {#–±—ç–∫–µ–Ω–¥}

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞

–í —Ñ–∞–π–ª–µ `src/server.ts`:

```typescript
// 1. –°–æ–∑–¥–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä (–Ω—É–∂–µ–Ω –¥–ª—è WebSocket)
const httpServer = createServer(app);

// 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SubscriptionServer –¥–ª—è WebSocket
const subscriptionServer = SubscriptionServer.create(
  {
    schema,              // GraphQL —Å—Ö–µ–º–∞
    execute,              // –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
    subscribe,            // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
    
    // –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket
    onConnect: async (connectionParams, webSocket) => {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      const token = connectionParams?.authorization?.replace('Bearer ', '');
      
      if (token) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        const payload = verifyToken(token);
        webSocket.context = {
          userId: payload.userId,
          userEmail: payload.email,
        };
        return webSocket.context;
      }
      return {};
    },
    
    // –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
    onDisconnect: () => {
      console.log('WebSocket client disconnected');
    },
    
    // –ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∑–∞–ø—Ä–æ—Å–∞/–ø–æ–¥–ø–∏—Å–∫–∏)
    onOperation: async (message, params, webSocket) => {
      // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ resolver
      if (webSocket.context) {
        params.context = webSocket.context;
      }
      return params;
    },
  },
  {
    server: httpServer,           // HTTP —Å–µ—Ä–≤–µ—Ä
    path: '/graphql',              // –ü—É—Ç—å –¥–ª—è WebSocket
  }
);
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket –∫ `ws://localhost:4000/graphql`
2. –ü–µ—Ä–µ–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω –≤ `connectionParams`
3. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
4. –¢–µ–ø–µ—Ä—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç WebSocket –±—É–¥—É—Ç –∏–º–µ—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### –®–∞–≥ 2: GraphQL Subscription –≤ —Å—Ö–µ–º–µ

–í —Ñ–∞–π–ª–µ `src/graphql/typeDefs.ts`:

```graphql
type Subscription {
  messageAdded(chatId: ID!): Message!
}
```

**–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:**
- –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ `messageAdded`
- –ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å `chatId` - –¥–ª—è –∫–∞–∫–æ–≥–æ —á–∞—Ç–∞ —Å–ª—É—à–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –æ–±—ä–µ–∫—Ç `Message`

---

### –®–∞–≥ 3: Resolver –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏

–í —Ñ–∞–π–ª–µ `src/graphql/resolvers.ts`:

```typescript
import { PubSub } from 'graphql-subscriptions';

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä PubSub (Publisher/Subscriber)
const pubsub = new PubSub();

export const resolvers = {
  Subscription: {
    messageAdded: {
      // –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ messageAdded
      subscribe: async (_: any, args: { chatId: string }, context: Context) => {
        const userId = getUserIdFromContext(context);
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const chat = await Chat.findById(args.chatId);
        if (!chat) {
          throw new UserInputError('Chat not found');
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —á–∞—Ç–∞
        if (!chat.participants.some((p: any) => p.toString() === userId)) {
          throw new ForbiddenError('You are not a participant of this chat');
        }

        // 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º asyncIterator –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
        // –ö–ª—é—á —É–Ω–∏–∫–∞–ª–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞: MESSAGE_ADDED_<chatId>
        return pubsub.asyncIterator(`MESSAGE_ADDED_${args.chatId}`);
      },
    },
  },
};
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç subscription –∑–∞–ø—Ä–æ—Å: `subscription { messageAdded(chatId: "123") }`
2. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `asyncIterator` - —ç—Ç–æ –∫–∞–Ω–∞–ª, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
4. –ö–∞–∂–¥—ã–π —á–∞—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª: `MESSAGE_ADDED_123`, `MESSAGE_ADDED_456`, –∏ —Ç.–¥.

---

### –®–∞–≥ 4: –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–í —Ñ–∞–π–ª–µ `src/graphql/resolvers.ts`:

```typescript
Mutation: {
  sendMessage: async (_: any, args: { input: {...} }, context: Context) => {
    const userId = getUserIdFromContext(context);
    const { chatId, content, imageUrl } = args.input;

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —É—á–∞—Å—Ç–Ω–∏–∫
    const chat = await Chat.findById(chatId);
    if (!chat) {
      throw new UserInputError('Chat not found');
    }
    
    if (!chat.participants.some((p: any) => p.toString() === userId)) {
      throw new ForbiddenError('You are not a participant of this chat');
    }

    // 2. –°–æ–∑–¥–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
    const message = new Message({
      chat: chatId,
      sender: userId,
      content,
      imageUrl,
    });
    await message.save();

    // 3. –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
    chat.updatedAt = new Date();
    await chat.save();

    // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å populate)
    const populatedMessage = await Message.findById(message._id)
      .populate('sender', '-password')
      .populate({
        path: 'chat',
        populate: {
          path: 'participants',
          select: '-password',
        },
      });

    // 5. ‚ö° –í–ê–ñ–ù–û: –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
    pubsub.publish(`MESSAGE_ADDED_${chatId}`, {
      messageAdded: populatedMessage,
    });

    // 6. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
    return populatedMessage;
  },
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ mutation `sendMessage`
2. –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MongoDB
3. **–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** `pubsub.publish()` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤—Å–µ–º, –∫—Ç–æ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª `MESSAGE_ADDED_<chatId>`
4. –í—Å–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ (–¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ —ç—Ç–æ–º —á–∞—Ç–µ) –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞—é—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

---

## üíª –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ {#—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥}

### –í–∞—Ä–∏–∞–Ω—Ç 1: Apollo Client (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install @apollo/client graphql subscriptions-transport-ws
```

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Apollo Client —Å WebSocket

```typescript
import { ApolloClient, InMemoryCache, split, HttpLink } from '@apollo/client';
import { getMainDefinition } from '@apollo/client/utilities';
import { GraphQLWsLink } from '@apollo/client/link/subscriptions';
import { createClient } from 'graphql-ws';
import { setContext } from '@apollo/client/link/context';

// HTTP —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (queries, mutations)
const httpLink = new HttpLink({
  uri: 'http://localhost:4000/graphql',
});

// WebSocket —Å—Å—ã–ª–∫–∞ –¥–ª—è subscriptions
const wsLink = new GraphQLWsLink(
  createClient({
    url: 'ws://localhost:4000/graphql',
    connectionParams: () => {
      // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage –∏–ª–∏ state
      const token = localStorage.getItem('token');
      return {
        authorization: token ? `Bearer ${token}` : '',
      };
    },
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    shouldRetry: () => true,
  })
);

// –°—Å—ã–ª–∫–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
const authLink = setContext((_, { headers }) => {
  const token = localStorage.getItem('token');
  return {
    headers: {
      ...headers,
      authorization: token ? `Bearer ${token}` : '',
    },
  };
});

// –†–∞–∑–¥–µ–ª—è–µ–º –∑–∞–ø—Ä–æ—Å—ã: subscriptions –∏–¥—É—Ç —á–µ—Ä–µ–∑ WebSocket, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —á–µ—Ä–µ–∑ HTTP
const splitLink = split(
  ({ query }) => {
    const definition = getMainDefinition(query);
    return (
      definition.kind === 'OperationDefinition' &&
      definition.operation === 'subscription'
    );
  },
  wsLink,      // –î–ª—è subscriptions
  authLink.concat(httpLink)  // –î–ª—è queries –∏ mutations
);

// –°–æ–∑–¥–∞–µ–º Apollo Client
const client = new ApolloClient({
  link: splitLink,
  cache: new InMemoryCache(),
});

export default client;
```

#### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ

```typescript
import { useSubscription, useMutation, useQuery } from '@apollo/client';
import { gql } from '@apollo/client';

// GraphQL –∑–∞–ø—Ä–æ—Å—ã
const GET_MESSAGES = gql`
  query GetMessages($chatId: ID!) {
    messages(chatId: $chatId, limit: 50) {
      id
      content
      imageUrl
      sender {
        id
        username
      }
      createdAt
    }
  }
`;

const SEND_MESSAGE = gql`
  mutation SendMessage($chatId: ID!, $content: String) {
    sendMessage(input: {
      chatId: $chatId
      content: $content
    }) {
      id
      content
      sender {
        id
        username
      }
      createdAt
    }
  }
`;

const MESSAGE_SUBSCRIPTION = gql`
  subscription OnMessageAdded($chatId: ID!) {
    messageAdded(chatId: $chatId) {
      id
      content
      imageUrl
      sender {
        id
        username
      }
      createdAt
    }
  }
`;

function ChatComponent({ chatId }: { chatId: string }) {
  // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const { data: messagesData, loading } = useQuery(GET_MESSAGES, {
    variables: { chatId },
  });

  // 2. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const { data: subscriptionData } = useSubscription(MESSAGE_SUBSCRIPTION, {
    variables: { chatId },
    // –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
    onData: ({ data }) => {
      if (data?.data?.messageAdded) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à Apollo Client
        client.cache.updateQuery(
          { query: GET_MESSAGES, variables: { chatId } },
          (existingMessages) => {
            return {
              messages: [
                ...(existingMessages?.messages || []),
                data.data.messageAdded,
              ],
            };
          }
        );
      }
    },
  });

  // 3. –ú—É—Ç–∞—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
  const [sendMessage] = useMutation(SEND_MESSAGE);

  const handleSendMessage = async (content: string) => {
    try {
      await sendMessage({
        variables: {
          chatId,
          content,
        },
        // –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ subscription
        // –ù–æ –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –≤—Ä—É—á–Ω—É—é
        update: (cache, { data }) => {
          if (data?.sendMessage) {
            cache.updateQuery(
              { query: GET_MESSAGES, variables: { chatId } },
              (existing) => {
                return {
                  messages: [
                    ...(existing?.messages || []),
                    data.sendMessage,
                  ],
                };
              }
            );
          }
        },
      });
    } catch (error) {
      console.error('Error sending message:', error);
    }
  };

  return (
    <div>
      {/* –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π */}
      <div>
        {messagesData?.messages?.map((message: any) => (
          <div key={message.id}>
            <strong>{message.sender.username}:</strong> {message.content}
          </div>
        ))}
      </div>

      {/* –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */}
      <form onSubmit={(e) => {
        e.preventDefault();
        const input = e.target.message;
        handleSendMessage(input.value);
        input.value = '';
      }}>
        <input name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>
  );
}
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞—Ç–∏–≤–Ω—ã–π WebSocket (–±–µ–∑ Apollo Client)

–ï—Å–ª–∏ –≤—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Apollo Client, –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é:

```typescript
import { SubscriptionClient } from 'subscriptions-transport-ws';

// –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
const wsClient = new SubscriptionClient('ws://localhost:4000/graphql', {
  reconnect: true,
  connectionParams: () => {
    const token = localStorage.getItem('token');
    return {
      authorization: `Bearer ${token}`,
    };
  },
});

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
const subscription = wsClient.request({
  query: `
    subscription OnMessageAdded($chatId: ID!) {
      messageAdded(chatId: $chatId) {
        id
        content
        sender {
          id
          username
        }
        createdAt
      }
    }
  `,
  variables: { chatId: 'your-chat-id' },
}).subscribe({
  next: (data) => {
    console.log('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data.data.messageAdded);
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    addMessageToChat(data.data.messageAdded);
  },
  error: (error) => {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
  },
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å
async function sendMessage(chatId: string, content: string) {
  const response = await fetch('http://localhost:4000/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('token')}`,
    },
    body: JSON.stringify({
      query: `
        mutation SendMessage($chatId: ID!, $content: String!) {
          sendMessage(input: {
            chatId: $chatId
            content: $content
          }) {
            id
            content
            sender {
              id
              username
            }
            createdAt
          }
        }
      `,
      variables: { chatId, content },
    }),
  });

  const result = await response.json();
  return result.data.sendMessage;
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
// subscription.unsubscribe();
```

---

## üìù –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è {#–ø—Ä–∏–º–µ—Ä}

### –°—Ü–µ–Ω–∞—Ä–∏–π: –¢—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—â–∞—é—Ç—Å—è –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ):

```typescript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –≤–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
const message = "–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!";

// 2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è mutation sendMessage
await sendMessage({
  variables: {
    chatId: "group-chat-123",
    content: message,
  },
});

// 3. –ù–∞ –±—ç–∫–µ–Ω–¥–µ:
//    - –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MongoDB
//    - pubsub.publish() –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–Ω–∞–ª MESSAGE_ADDED_group-chat-123
```

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –∏ C (–ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ):

```typescript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ B –∏ C —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ subscription:
useSubscription(MESSAGE_SUBSCRIPTION, {
  variables: { chatId: "group-chat-123" },
  onData: ({ data }) => {
    // 2. –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–±—ã—Ç–∏–µ –æ—Ç pubsub.publish()
    //    –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —ç—Ç–æ—Ç callback
    const newMessage = data.data.messageAdded;
    
    // 3. –û–±–Ω–æ–≤–ª—è–µ–º UI - –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫
    setMessages(prev => [...prev, newMessage]);
  },
});

// –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ B –∏ C –≤–∏–¥—è—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç A –ú–ì–ù–û–í–ï–ù–ù–û
// –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã!
```

---

## üîÑ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã Real-Time

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ü–û–õ–ù–´–ô –¶–ò–ö–õ                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç
   ‚Üì
   Frontend: useSubscription(MESSAGE_SUBSCRIPTION, { chatId })
   ‚Üì
   WebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ws://localhost:4000/graphql
   ‚Üì
   Backend: onConnect() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
   ‚Üì
   Backend: messageAdded.subscribe() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç asyncIterator
   ‚Üì
   Frontend: –ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–±—ã—Ç–∏—è

2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
   ‚Üì
   Frontend: sendMessage mutation
   ‚Üì
   Backend: sendMessage resolver
   ‚Üì
   Backend: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ MongoDB
   ‚Üì
   Backend: pubsub.publish('MESSAGE_ADDED_<chatId>', { messageAdded })
   ‚Üì
   Backend: PubSub –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –∫–∞–Ω–∞–ª–∞

3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ B –∏ C –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
   ‚Üì
   Backend: asyncIterator –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –æ—Ç PubSub
   ‚Üì
   WebSocket: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ WebSocket
   ‚Üì
   Frontend: onData callback –≤ useSubscription
   ‚Üì
   Frontend: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫)
   ‚Üì
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ B –∏ C –≤–∏–¥—è—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ú–ì–ù–û–í–ï–ù–ù–û
```

---

## ‚ùì –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã {#faq}

### Q1: –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ WebSocket?

**A:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ subscription, –æ–Ω –Ω–µ –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –ù–æ:
- –°–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–∞ (—á–µ—Ä–µ–∑ `query messages`) –æ–Ω —É–≤–∏–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ subscription –æ–Ω –ø–æ–ª—É—á–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### Q2: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è?

**A:** 
- WebSocket –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ `shouldRetry: true`)
- –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Å–Ω–æ–≤–∞ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ subscription
- –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π query

### Q3: –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ?

**A:** –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–æ–∫:

```typescript
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —á–∞—Ç 1
useSubscription(MESSAGE_SUBSCRIPTION, { variables: { chatId: 'chat-1' } });

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —á–∞—Ç 2
useSubscription(MESSAGE_SUBSCRIPTION, { variables: { chatId: 'chat-2' } });
```

–ö–∞–∂–¥–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

### Q4: –ö–∞–∫ —É–∑–Ω–∞—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω?

**A:** –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –°–æ–±—ã—Ç–∏–µ `userConnected` –ø—Ä–∏ `onConnect`
- –°–æ–±—ã—Ç–∏–µ `userDisconnected` –ø—Ä–∏ `onDisconnect`
- –•—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ Redis

### Q5: –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket?

**A:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –º–æ–∂–Ω–æ, –Ω–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mutation —á–µ—Ä–µ–∑ HTTP:
- Mutations –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–º–∏ (HTTP –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É)
- Subscriptions —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ GraphQL

### Q6: –ß—Ç–æ —Ç–∞–∫–æ–µ PubSub –∏ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç?

**A:** PubSub (Publisher/Subscriber) - —ç—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —Å–æ–±—ã—Ç–∏–π:
- **Publisher** (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å): `pubsub.publish('channel', data)` - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ
- **Subscriber** (–ø–æ–¥–ø–∏—Å—á–∏–∫): `pubsub.asyncIterator('channel')` - –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è
- –ö–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª –Ω–µ–∑–∞–≤–∏—Å–∏–º: `MESSAGE_ADDED_chat1` –∏ `MESSAGE_ADDED_chat2` –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è

### Q7: –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ —ç—Ç–æ?

**A:** –î–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è:
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT —Ç–æ–∫–µ–Ω –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ WebSocket
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ subscription resolver (—Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞ –º–æ–≥—É—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å)

---

## üéì –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1. WebSocket vs HTTP
- **HTTP**: –ó–∞–ø—Ä–æ—Å ‚Üí –û—Ç–≤–µ—Ç ‚Üí –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **WebSocket**: –û—Ç–∫—Ä—ã—Ç–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Üí –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–≤—è–∑—å ‚Üí –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

### 2. GraphQL Subscriptions
- –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ GraphQL
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ WebSocket
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### 3. PubSub Pattern
- –ü–∞—Ç—Ç–µ—Ä–Ω "–ò–∑–¥–∞—Ç–µ–ª—å-–ü–æ–¥–ø–∏—Å—á–∏–∫"
- –û–¥–∏–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, –º–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- –°–æ–±—ã—Ç–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –∫–∞–Ω–∞–ª–∞

### 4. AsyncIterator
- –≠—Ç–æ –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
- GraphQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –¥–ª—è subscriptions
- –î–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ –º–µ—Ä–µ –ø–æ—è–≤–ª–µ–Ω–∏—è

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ—Ä–∞

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
   ```bash
   npm install @apollo/client graphql subscriptions-transport-ws
   ```

2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Apollo Client** (—Å–º. —Ä–∞–∑–¥–µ–ª "–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ")

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ useSubscription –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:**
   ```typescript
   const { data } = useSubscription(MESSAGE_SUBSCRIPTION, {
     variables: { chatId },
   });
   ```

4. **–ì–æ—Ç–æ–≤–æ!** –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [GraphQL Subscriptions –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://www.apollographql.com/docs/react/data/subscriptions/)
- [WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- [PubSub –ø–∞—Ç—Ç–µ—Ä–Ω](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern)

---

**–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ - —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ!** üöÄ

